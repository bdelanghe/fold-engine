# Linked Data Architecture

This document outlines the Linked Data standards and graph integrity features
being added to Unfold.

## Overview

Unfold is evolving from a static site generator into a **deterministic Linked
Data compiler** with formal graph integrity guarantees. This architecture
document describes the W3C standards being adopted and the validation contracts
being enforced.

## Core Principles

1. **Deterministic builds** - Same vault input always produces identical outputs
2. **Schema-first** - Validate early, fail fast with clear errors
3. **No bad links** - Every internal link must resolve to an existing object
4. **No orphan objects** - Every object must be reachable from known roots
5. **Standard compliance** - Use W3C Linked Data standards, not custom formats

## Standards Being Adopted

### 1. Node Naming: Cool URIs for the Semantic Web

**Standard:** [W3C Cool URIs](https://www.w3.org/TR/cooluris/)

**URI Patterns:**

- **Pages** (slash URIs): `https://site/pages/cognitive-folding`
- **Sections** (hash URIs): `https://site/pages/cognitive-folding#introduction`
- **Vocabulary terms** (hash URIs): `https://site/vocab/basis#Fold`
- **References** (slash URIs): `https://site/refs/wai-aria`

**Strategy:**

- Slash URIs for documents/resources (good for content negotiation)
- Hash URIs for terms within vocabularies (good for bundled definitions)
- All identifiers are IRIs (internationalized URIs)
- Each node has exactly one canonical `@id`

**Issue:** bdelanghe-9lu (P0)

### 2. Dataset Cataloging: DCAT

**Standard:** [W3C DCAT v3](https://www.w3.org/TR/vocab-dcat-3/)

**Purpose:** "Registry of everything that exists"

**Output:** `catalog.jsonld`

**Contents:**

- List of all datasets: pages, vocab, refs
- Distributions for each resource (.html, .md, .jsonld)
- Primary discovery mechanism for agents and tools

**Issue:** bdelanghe-zdl (P0)

### 3. Graph Statistics: VoID

**Standard:** [W3C VoID](https://www.w3.org/TR/void/)

**Purpose:** Structural metadata and inter-dataset links

**Output:** `void.jsonl` (optional)

**Contents:**

- Node sets and linksets
- Graph statistics (triple counts, distinct subjects, etc.)
- Dataset-to-dataset link descriptions

**Issue:** bdelanghe-qyr (P2)

### 4. Updates: Linked Data Platform (LDP)

**Standard:** [W3C LDP 1.0](https://www.w3.org/TR/ldp/)

**Purpose:** HTTP-based CRUD for RDF resources

**HTTP Semantics:**

- `POST` - Create new resources in a container
- `PUT` - Replace a resource representation
- `PATCH` - Partial modification
- `DELETE` - Remove a resource

**Use Case:** "Vault as structured notes on the web"

**Issue:** bdelanghe-vv8 (P1)

### 5. Partial Updates: LD Patch

**Standard:** [W3C LD Patch](https://www.w3.org/TR/ldpatch/)

**Purpose:** Format for HTTP PATCH operations on Linked Data

**Use Case:** Granular edits without whole-document replacement

**Issue:** bdelanghe-5cm (P2)

### 6. Query Language: SPARQL 1.1 Update

**Standard:** [W3C SPARQL 1.1 Update](https://www.w3.org/TR/sparql11-update/)

**Purpose:** Graph-level mutation language

**Operations:**

- `INSERT DATA` / `DELETE DATA`
- `DELETE/INSERT WHERE`
- Graph management

**Status:** Future consideration if triple-store backend is added

## Graph Integrity Guarantees

### Invariants (Enforced in CI)

**I1 - Target Existence (Internal Links)**

- Every internal edge must point to an existing `@id`
- Broken internal links cause build failure

**I2 - Canonical ID Uniqueness**

- No duplicate `@id` values
- Each object has exactly one identity

**I3 - Ref Integrity**

- Every `[[citation:X]]` must resolve to `refs/X.md`
- That ref must have a valid `id:` URL in frontmatter

**I4 - Reachability**

- All non-exempt objects must be reachable from roots
- Roots: catalog, entrypoints, pages marked with `basis:role = entrypoint`

**I5 - Bidirectional Coherence (Optional)**

- If A has `hasPart` B, then B should have `isPartOf` A
- Auto-generated by compiler (self-healing)

### Link Resolution

**Core Function:** `resolve(targetToken) -> @id | error`

**Handles:**

1. **Typed internal links:**
   - `[[citation:WAI-ARIA]]` → `refs/WAI-ARIA.md` → frontmatter `id:` URL
   - `[[concept:Fold]]` → `vocab/basis__Fold.md` → `@id`
   - `[[page:cognitive-folding]]` → `pages/cognitive-folding.jsonld` → `@id`

2. **Raw internal IDs:**
   - `https://site/path/#section` → must exist in node index

3. **External URLs:**
   - Kept as external edge
   - Optional HTTP reachability check

**Issue:** bdelanghe-1kw (P0)

### Validation Pipeline

**Step A - Index Nodes**

```typescript
const nodesById = new Map<string, Node>();
for (const node of allNodes) {
  if (nodesById.has(node["@id"])) {
    throw new Error(`Duplicate @id: ${node["@id"]}`);
  }
  nodesById.set(node["@id"], node);
}
```

**Issue:** bdelanghe-xkc (P0)

**Step B - Extract Edges**

```typescript
for (const node of allNodes) {
  for (const edge of extractEdges(node)) {
    edges.push({
      source: node["@id"],
      predicate: edge.type,
      target: edge.target,
    });
  }
}
```

**Step C - Validate Internal Links**

```typescript
for (const edge of edges) {
  if (isInternal(edge.target) && !nodesById.has(edge.target)) {
    throw new Error(`Bad internal link: ${edge.source} -> ${edge.target}`);
  }
}
```

**Step D - Enforce Reachability**

```typescript
const roots = findRoots(); // catalog, entrypoints
const reachable = bfs(roots, edges);
const orphans = difference(nodesById.keys(), reachable);
const allowedOrphans = orphans.filter((id) => isExempt(nodesById.get(id)));
const badOrphans = difference(orphans, allowedOrphans);
if (badOrphans.size > 0) {
  throw new Error(`Orphan objects: ${Array.from(badOrphans)}`);
}
```

**Issue:** bdelanghe-k1w (P1)

### Validation Modes

**Strict Mode (CI Gate)**

- Bad internal link → **error**
- Orphan object (not reachable) → **error**
- Duplicate `@id` → **error**
- Exit code 1 on any violation

**Dev Mode (Authoring)**

- Bad internal link → **error** (blocking)
- Orphan object → **warning** with hint: "link it from an index page"
- Duplicate `@id` → **error**
- Exit code 0 unless errors

**Issue:** bdelanghe-v4n (P1)

## Self-Healing Features

### Bidirectional Link Generation

When author writes:

```yaml
# pages/article.md
hasPart:
  - https://site/pages/article#intro
  - https://site/pages/article#methods
```

Compiler auto-generates:

```jsonld
{
  "@id": "https://site/pages/article#intro",
  "isPartOf": "https://site/pages/article"
}
```

**Benefits:**

- Keeps authoring low-friction (write one direction)
- Maintains graph coherence (both directions always consistent)
- No duplicate maintenance

**Issue:** bdelanghe-cts (P2)

### Stub Ref Generation (Optional)

When author writes:

```markdown
See [[citation:WAI-ARIA]] for details.
```

If `refs/WAI-ARIA.md` doesn't exist:

- Compiler creates stub file with warning
- Build continues (warning mode)
- Author must fill in canonical URL later
- Strict mode: error until ref is complete

## Implementation Phases

### Phase 1: Foundation (P0)

1. Cool URIs naming strategy (bdelanghe-9lu)
2. Link resolver (bdelanghe-1kw)
3. Graph validation pass (bdelanghe-xkc)
4. DCAT catalog (bdelanghe-zdl)

### Phase 2: Integrity Enforcement (P1)

5. Reachability validation (bdelanghe-k1w)
6. Strict/dev validation modes (bdelanghe-v4n)
7. LDP support for updates (bdelanghe-vv8)

### Phase 3: Advanced Features (P2)

8. LD Patch format (bdelanghe-5cm)
9. VoID vocabulary (bdelanghe-qyr)
10. Bidirectional link auto-generation (bdelanghe-cts)

## Integration with Existing Pipeline

### Current Pipeline

```
vault/ → inputs/ → pipeline/ → manifests/ → renderers/ → exporters/ → dist/
```

### New Validation Pass

```
vault/
  ↓
inputs/ (frontmatter, markdown)
  ↓
pipeline/validate.ts
  ├─ Cool URI normalization
  ├─ Link resolution
  ├─ Graph validation (I1, I2, I3)
  └─ Reachability check (I4)
  ↓
pipeline/render.ts
  ↓
exporters/
  ├─ catalog.jsonld (DCAT)
  ├─ void.jsonld (VoID)
  ├─ jsonld/ (per-page exports)
  └─ graph.jsonld (full graph)
  ↓
dist/
```

### New Module: `graph/`

Create `src/unfold/graph/` with:

- `uris.ts` - Cool URI resolution and normalization
- `resolver.ts` - Link resolver (targetToken → @id)
- `validator.ts` - Graph validation (I1-I5)
- `reachability.ts` - BFS/DFS reachability checks
- `catalog.ts` - DCAT catalog generation
- `void.ts` - VoID statistics generation

## Testing Strategy

### Unit Tests

- URI normalization (hash vs slash)
- Link resolver for each link type
- Node index construction
- Edge extraction

### Integration Tests

- Full pipeline with valid vault (should pass)
- Bad internal link (should fail with clear error)
- Orphan object (should fail or warn)
- Duplicate @id (should fail)
- DCAT catalog generation (golden output)

### Contract Tests

- Output schemas: catalog.schema.json, void.schema.json
- Golden files: catalog.expected.jsonl, void.expected.jsonl

## Success Criteria

### Validation Works When:

1. Build fails on broken internal link with clear error message
2. Build fails on orphan object (or warns in dev mode)
3. Build fails on duplicate @id
4. All internal links resolve deterministically
5. DCAT catalog accurately lists all resources
6. CI enforces strict mode, dev mode provides hints

### Ready for Production When:

1. All P0 issues closed (Cool URIs, resolver, validation, DCAT)
2. All tests passing (unit, integration, contract)
3. CI gate in place (`deno task ci` includes graph validation)
4. Documentation updated (CLAUDE.md, ARCHITECTURE.md)
5. At least one example vault demonstrates full feature set

## References

- [W3C Cool URIs for the Semantic Web](https://www.w3.org/TR/cooluris/)
- [W3C Linked Data Platform 1.0](https://www.w3.org/TR/ldp/)
- [W3C LD Patch](https://www.w3.org/TR/ldpatch/)
- [W3C DCAT v3](https://www.w3.org/TR/vocab-dcat-3/)
- [W3C VoID](https://www.w3.org/TR/void/)
- [W3C SPARQL 1.1 Update](https://www.w3.org/TR/sparql11-update/)
- [Best Practice Recipes for Publishing RDF Vocabularies](https://www.w3.org/TR/swbp-vocab-pub/)

## Issue Tracking

All work tracked in beads:

```bash
bd ready                    # Show available work
bd dep tree bdelanghe-v4n   # Show validation chain
bd dep tree bdelanghe-5cm   # Show update capabilities chain
```

Primary chains:

- **Integrity:** Cool URIs → Link Resolver → Graph Validation → Reachability →
  Validation Modes
- **Updates:** Cool URIs → DCAT Catalog → LDP Support → LD Patch
